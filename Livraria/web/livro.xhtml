<ui:composition template="/WEB-INF/templates/layout.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ms="http://xmlns.jcp.org/jsf/composite/mscomp"
                xmlns:pn="http://xmlns.jcp.org/jsf/composite/mscomp">
    <ui:define name="content">
        <h2 class="page-header">Gerenciar Livro</h2>
        <ms:mensagem/>
        <h:form id="formPrincipal" enctype="multipart/form-data">
            <pn:dataTableCrud crudBean="#{livroBean}" arquivo="livros">
                <p:column headerText="Título" sortBy="#{lista.titulo}" filterBy="#{lista.titulo}">
                    <h:outputText value="#{lista.titulo}" />
                </p:column>

                <p:column headerText="ISBN" sortBy="#{lista.isbn}" filterBy="#{lista.isbn}" style="width: 155px">
                    <h:outputText value="#{lista.isbn}" />
                </p:column>

                <p:column headerText="Edição" sortBy="#{lista.edicao}" filterBy="#{lista.edicao}" style="width: 90px">
                    <h:outputText value="#{lista.edicao}" />
                </p:column>

                <p:column headerText="Ano" sortBy="#{lista.ano}" filterBy="#{lista.ano}" style="width: 70px">
                    <h:outputText value="#{lista.ano}">
                        <f:convertDateTime pattern="yyyy"/>
                    </h:outputText>
                </p:column>                 

                <p:column headerText="Editora" sortBy="#{lista.editoraid.nomeEditora}" filterBy="#{lista.editoraid.nomeEditora}" style="width: 100px">
                    <h:outputText value="#{lista.editoraid.nomeEditora}" />
                </p:column>

                <p:column headerText="Assunto" sortBy="#{lista.assuntoid.nomeAssunto}" filterBy="#{lista.assuntoid.nomeAssunto}">
                    <h:outputText value="#{lista.assuntoid.nomeAssunto}" />
                </p:column>

                <p:column headerText="Autores" style="width:75px" exportable="false">
                    <p:rowToggler/>                    
                </p:column>

                <p:rowExpansion>
                    <p:dataTable  
                        var="autor" 
                        value="#{lista.autorList}"
                        id="tabela2" 
                        emptyMessage="Nenhum registro encontrado"
                        style="width:30%; float: right">
                        <f:facet name="header">
                            Autores do Livro #{lista.titulo}
                        </f:facet>
                        <p:column headerText="Nome">
                            <center>
                                <h:outputText value="#{autor.nomeAutor}" />
                            </center>
                        </p:column>
                    </p:dataTable>
                </p:rowExpansion>

            </pn:dataTableCrud>

            <center>                    
                <p:panel rendered="#{!livroBean.tabela}" header="Novo/Editar Livro" style="width:85%">
                    <p:panelGrid id="panelRecord" columns="6" columnClasses="grade, grade, grade, grade, grade, grade"> 
                        <p:outputLabel value="Título: " for="titulo" style="float: right;" />
                        <p:inputText id="titulo" 
                                     value="#{livroBean.entidade.titulo}"
                                     required="true"
                                     validatorMessage="Título inválido"
                                     requiredMessage="Título em branco">
                            <f:validateRegex pattern="[A-za-z]+( [A-za-z]+)*" />
                        </p:inputText>   
                        <p:outputLabel value="ISBN: " for="isbn" style="float: right;" />
                        <p:inputMask mask="999-99-999-9999-9" 
                                     id="isbn"
                                     value="#{livroBean.entidade.isbn}"
                                     required="true"
                                     requiredMessage="ISBN em branco"/>
                        <p:outputLabel value="Edição: " for="edicao" style="float: right;" />                       
                        <p:inputText id="edicao" 
                                     value="#{livroBean.entidade.edicao}"
                                     required="true"
                                     requiredMessage="Edição em branco"/>
                        <p:outputLabel value="Ano: " for="ano" style="float: right;" />
                        <p:calendar locale="pt" 
                                    navigator="true" 
                                    pattern="dd/MM/yyyy" 
                                    id="ano" 
                                    value="#{livroBean.entidade.ano}"
                                    required="true"
                                    requiredMessage="Forneça uma data"/> 
                        <p:outputLabel value="Editora: " for="editora" style="float: right;" />
                        <p:selectOneMenu id="editora"
                                         value="#{livroBean.editoraId}"
                                         style="width: 205px"                                         
                                         required="true"
                                         filter="true"
                                         filterMatchMode="startsWith"
                                         requiredMessage="Selecione uma editora">
                            <f:selectItem itemLabel="Selecione" itemValue=""/>
                            <f:selectItems value="#{livroBean.editora.entidades}"
                                           var="editora"
                                           itemLabel="#{editora.nomeEditora}"
                                           itemValue="#{editora.id}"/>
                        </p:selectOneMenu>
                        <p:outputLabel value="Assunto: " for="assunto" style="float: right;" />
                        <p:selectOneMenu id="assunto"
                                         value="#{livroBean.assuntoId}"
                                         style="width: 205px"                                         
                                         required="true"
                                         filter="true"
                                         filterMatchMode="startsWith"
                                         requiredMessage="Selecione um assunto">
                            <f:selectItem itemLabel="Selecione" itemValue=""/>
                            <f:selectItems value="#{livroBean.assunto.entidades}"
                                           var="assunto"
                                           itemLabel="#{assunto.nomeAssunto}"
                                           itemValue="#{assunto.id}"/>
                        </p:selectOneMenu>

                        <h:outputLabel value="Selecione Autor: " for="aut" style="float: right;"/>
                        <p:selectOneMenu id="aut"
                                         value="#{livroBean.autorId}" 
                                         filter="true"
                                         filterMatchMode="startsWith"
                                         style="width: 205px">
                            <f:selectItem itemLabel="Selecione" noSelectionOption="true"/>
                            <f:selectItems value="#{livroBean.autor.entidades}" 
                                           var="autor"
                                           itemLabel="#{autor.nomeAutor}"
                                           itemValue="#{autor.id}"/>
                        </p:selectOneMenu>
                        <p:commandButton id="adiciona"
                                         image="adicionar"
                                         style="width: 34px; height: 28px; align-items: center"
                                         value=""
                                         ajax="false"
                                         update=":formPrincipal:panelTabela"
                                         action="#{livroBean.adicionarAutor()}"/>
                        <p:tooltip id="toolTipAdicionar" for="adiciona" value="Adicionar autor" position="top"/>

                        <p:outputLabel value="Enviar PDF: " for="fileUpload" style="float: right;" />
                        <p:fileUpload value="#{livroBean.uploadedFile}"
                                      accept="application/pdf"                                      
                                      id="fileUpload"
                                      mode="simple" 
                                      skinSimple="true" />                     


                    </p:panelGrid> 
                    <br/>
                    <p:panel id="panelTabela" style="width:80%; border: none">
                        <h4>Autores do Livro:</h4>
                        <h:dataTable value="#{livroBean.autoresDoLivro}" 
                                     var="autor" 
                                     style="width:15%">
                            <h:column>                            
                                <h:outputText value="#{autor.nomeAutor}"/>
                            </h:column>
                            <h:column>
                                <center>
                                    <p:commandButton id="excluir"
                                                     style="width: 34px; height: 20px; align-items: center" 
                                                     image="delete"
                                                     value="" 
                                                     action="#{livroBean.removerAutor(autor)}" 
                                                     update=":formPrincipal:panelTabela"/>
                                    <p:tooltip id="toolTipDeletar" for="excluir" value="Excluir autor" position="top"/>
                                </center>
                            </h:column>
                        </h:dataTable>
                        <br/>
                        <p:commandButton icon="ui-icon-disk"
                                         value="Salvar"
                                         rendered="#{livroBean.entidade.autorList.size() > 0}"
                                         ajax="false"
                                         update="@form" 
                                         action="#{livroBean.setTabela(true)}" 
                                         actionListener="#{livroBean.gravar}" 
                                         onclick="record.hide()" 
                                         alt="Record"/> 
                        <p:commandButton icon="ui-icon-refresh" 
                                         value="Voltar"
                                         ajax="false"
                                         immediate="true"
                                         update="@form" 
                                         action="#{livroBean.setTabela(true)}"/> 
                    </p:panel>
                </p:panel>
            </center>

        </h:form>
    </ui:define>
</ui:composition>