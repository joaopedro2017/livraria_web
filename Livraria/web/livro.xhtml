<ui:composition template="/WEB-INF/templates/layout.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ms="http://xmlns.jcp.org/jsf/composite/mscomp"
                xmlns:pn="http://xmlns.jcp.org/jsf/composite/mscomp">
    <ui:define name="content">
        <h2 class="page-header">Gerenciar Livro</h2>
        <ms:mensagem/>
        <h:form id="formPrincipal">
            <pn:dataTableCrud crudBean="#{livroBean}" arquivo="livros">
                <p:column headerText="Título" sortBy="#{lista.titulo}" filterBy="#{lista.titulo}">
                    <h:outputText value="#{lista.titulo}" />
                </p:column>

                <p:column headerText="ISBN" sortBy="#{lista.isbn}" filterBy="#{lista.isbn}" style="width: 155px">
                    <h:outputText value="#{lista.isbn}" />
                </p:column>

                <p:column headerText="Edição" sortBy="#{lista.edicao}" filterBy="#{lista.edicao}" style="width: 90px">
                    <h:outputText value="#{lista.edicao}" />
                </p:column>

                <p:column headerText="Ano" sortBy="#{lista.ano}" filterBy="#{lista.ano}" style="width: 100px">
                    <h:outputText value="#{lista.ano}">
                        <f:convertDateTime pattern="dd/MM/yyyy"/>
                    </h:outputText>
                </p:column>                 

                <p:column headerText="Editora" sortBy="#{lista.editoraid.nomeEditora}" filterBy="#{lista.editoraid.nomeEditora}" style="width: 100px">
                    <h:outputText value="#{lista.editoraid.nomeEditora}" />
                </p:column>

                <p:column headerText="Assunto" sortBy="#{lista.assuntoid.nomeAssunto}" filterBy="#{lista.assuntoid.nomeAssunto}">
                    <h:outputText value="#{lista.assuntoid.nomeAssunto}" />
                </p:column>

                <p:column headerText="Autores" style="width:75px">
                    <p:rowToggler/>                    
                </p:column>

                <p:rowExpansion>
                    <p:dataTable  
                        var="autor" 
                        value="#{lista.autorList}"
                        id="tabela2" 
                        emptyMessage="Nenhum registro encontrado"
                        style="width:30%; float: right">
                        <f:facet name="header">
                            Autores do Livro #{lista.titulo}
                        </f:facet>
                        <p:column headerText="Nome">
                            <center>
                                <h:outputText value="#{autor.nomeAutor}" />
                            </center>
                        </p:column>
                    </p:dataTable>
                </p:rowExpansion>

            </pn:dataTableCrud>

            <center>                    
                <p:panel rendered="#{!livroBean.tabela}" header="Novo/Editar Livro" style="width:85%">
                    <p:panelGrid id="panelRecord" columns="6">                    
                        Título:
                        <p:inputText id="titulo" 
                                     value="#{livroBean.entidade.titulo}"
                                     required="true"
                                     requiredMessage="Título em branco"/>    
                        ISBN:
                        <p:inputMask mask="999-99-999-9999-9" 
                                     id="isbn"
                                     value="#{livroBean.entidade.isbn}"
                                     required="true"
                                     requiredMessage="ISBN em branco"/>
                        Edição:
                        <p:inputMask mask="9999"
                                     id="edicao" 
                                     value="#{livroBean.entidade.edicao}"
                                     required="true"
                                     requiredMessage="Edição em branco"/>
                        Ano:
                        <p:calendar locale="pt" 
                                    navigator="true" 
                                    pattern="dd/MM/yyyy" 
                                    id="ano" 
                                    value="#{livroBean.entidade.ano}"
                                    required="true"
                                    requiredMessage="Forneça uma data"/> 
                        Editora:
                        <p:selectOneMenu value="#{livroBean.entidade.editoraid}"
                                         style="width: 205px" 
                                         required="true"
                                         requiredMessage="Selecione a editora">
                            <f:selectItem itemLabel="Selecione" itemValue=""/>
                            <f:selectItems value="#{editoraBean.itens}"/>
                        </p:selectOneMenu>
                        Assunto:
                        <p:selectOneMenu value="#{livroBean.entidade.assuntoid}"
                                         style="width: 205px" 
                                         required="true"
                                         requiredMessage="Selecione o assunto">
                            <f:selectItem itemLabel="Selecione" itemValue=""/>
                            <f:selectItems value="#{assuntoBean.itens}"/>
                        </p:selectOneMenu>

                        <h:outputLabel value="Secionar Autor: " for="autor"/>
                        <p:selectOneMenu value="#{livroBean.autorId}" 
                                         style="width: 205px">
                            <f:selectItem itemLabel="Selecione" itemValue=""/>
                            <f:selectItems value="#{livroBean.autores}" 
                                           var="autor"
                                           itemLabel="#{autor.nomeAutor}"
                                           itemValue="#{autor.id}"/>
                        </p:selectOneMenu>
                        <p:commandButton id="adiciona"
                                         icon="ui-icon-plus"
                                         style="width: 34px; height: 28px; align-items: center"
                                         value="" 
                                         action="#{livroBean.adicionarAutor()}" 
                                         update=":formPrincipal:panelTabela"/>
                        <p:tooltip id="toolTipAdicionar" for="adiciona" value="Adicionar autor" position="top"/>
                    </p:panelGrid>                    

                    <p:panel id="panelTabela" style="width:80%; border: none">
                        <h4>Autores do Livro:</h4>
                        <h:dataTable value="#{livroBean.autoresDoLivro}" 
                                     var="autor" 
                                     style="width:15%">
                            <h:column>                            
                                <h:outputText value="#{autor.nomeAutor}"/>
                            </h:column>
                            <h:column>
                                <center>
                                    <p:commandButton id="excluir"
                                                     style="width: 34px; height: 20px; align-items: center" 
                                                     icon="ui-icon-trash" 
                                                     value="" 
                                                     action="#{livroBean.removerAutor(autor)}" 
                                                     update=":formPrincipal:panelTabela"/>
                                    <p:tooltip id="toolTipDeletar" for="excluir" value="Excluir autor" position="top"/>
                                </center>
                            </h:column>
                        </h:dataTable>
                        <br/>
                        <p:commandButton icon="ui-icon-disk"
                                         value="Salvar"
                                         rendered="#{livroBean.entidade.autorList.size() > 0}"
                                         update="@form" 
                                         action="#{livroBean.setTabela(true)}" 
                                         actionListener="#{livroBean.record}" 
                                         onclick="record.hide()" 
                                         alt="Record"/> 
                        <p:commandButton icon="ui-icon-refresh" 
                                         value="Voltar"
                                         immediate="true"
                                         update="@form" 
                                         action="#{livroBean.setTabela(true)}"/> 
                    </p:panel>
                </p:panel>
            </center>

        </h:form>
    </ui:define>
</ui:composition>